# Refactor scripts/ into Cleaner Layout

## Current Directory Structure Analysis

```
scripts/
├── analyse/                   # Mixed issue analysis
├── combine/                   # CSV operations
├── config/                    # Configuration files
├── debug/                     # Debug utilities
├── filters/                   # Repository filtering
├── fix/                       # Data correction scripts
├── github_client/             # Core API client
├── merged_prs_30d/            # PR metrics
├── org-research/              # Organization collection
├── collect_issues_to_csv.py   # Standalone issue script
├── orchestrator.py            # Pipeline orchestration
└── run_collection.py          # Main entry point
```

**Problems with Current Structure:**
- Mixed responsibilities across directories
- Unclear separation between issues, orgs, and repos operations
- Scattered utility functions
- Difficult to locate specific functionality
- No clear hierarchy of operations

## Proposed New Directory Structure

```
scripts/
├── issues/                    # All issue-related operations
│   ├── __init__.py
│   ├── collector.py           # Core issue collection
│   ├── analyzer.py            # Issue analysis and metrics
│   ├── exporters/
│   │   ├── csv_exporter.py    # Export to CSV format
│   │   └── markdown_exporter.py # Export to Markdown
│   ├── processors/
│   │   ├── batch_processor.py # Process multiple repos
│   │   └── filter_processor.py # Filter issues by criteria
│   └── models.py              # Issue-specific data models
│
├── orgs/                      # All organization-related operations
│   ├── __init__.py
│   ├── collector.py           # Collect org repositories
│   ├── analyzer.py            # Org-level analytics
│   ├── processors/
│   │   ├── batch_processor.py # Process multiple orgs
│   │   └── repo_aggregator.py # Aggregate repo data
│   ├── reports/
│   │   ├── summary_report.py  # Org summary reports
│   │   └── metrics_report.py  # Detailed metrics
│   └── models.py              # Organization data models
│
├── repos/                     # All repository-related operations
│   ├── __init__.py
│   ├── collector.py           # Repository data collection
│   ├── analyzer.py            # Repository analysis
│   ├── metrics/
│   │   ├── pr_metrics.py      # PR-related metrics
│   │   ├── issue_metrics.py   # Issue-related metrics
│   │   └── activity_metrics.py # Activity metrics
│   ├── filters/
│   │   ├── date_filter.py     # Filter by date
│   │   ├── activity_filter.py # Filter by activity
│   │   ├── size_filter.py     # Filter by size
│   │   └── percentile_filter.py # Top percentile
│   ├── fixers/
│   │   ├── count_fixer.py     # Fix count discrepancies
│   │   ├── pr_fixer.py        # Fix PR counts
│   │   └── data_validator.py  # Validate and fix data
│   └── models.py              # Repository data models
│
├── github_client/             # Core GitHub API interface
│   ├── __init__.py
│   ├── client.py              # Base API client
│   ├── auth.py                # Authentication handling
│   ├── rate_limiter.py        # Rate limit management
│   └── exceptions.py          # Custom exceptions
│
├── pipeline/                  # Orchestration and workflows
│   ├── __init__.py
│   ├── orchestrator.py        # Main pipeline orchestrator
│   ├── workflows/
│   │   ├── issue_workflow.py  # Issue collection workflow
│   │   ├── org_workflow.py    # Org analysis workflow
│   │   └── repo_workflow.py   # Repo analysis workflow
│   ├── schedulers/
│   │   └── batch_scheduler.py # Schedule batch jobs
│   └── config.py              # Pipeline configuration
│
├── utils/                     # Shared utilities
│   ├── __init__.py
│   ├── csv_utils.py           # CSV operations
│   ├── markdown_utils.py      # Markdown generation
│   ├── file_utils.py          # File operations
│   ├── date_utils.py          # Date handling
│   └── validators.py          # Data validation
│
├── models/                    # Shared data models
│   ├── __init__.py
│   ├── base.py                # Base model classes
│   ├── github_models.py       # GitHub API models
│   └── output_models.py       # Output format models
│
├── config/                    # Configuration management
│   ├── __init__.py
│   ├── repositories.yml       # Repository list
│   ├── organizations.yml      # Organization list
│   ├── settings.py            # Settings loader
│   └── constants.py           # Constants
│
├── debug/                     # Debug and testing tools
│   └── [keep existing]
│
├── __init__.py
├── run_collection.py          # Main entry point
└── cli.py                     # Command-line interface
```

## Refactoring Implementation Plan

### Phase 1: Setup New Structure (Day 1)
1. Create all new directories
2. Add __init__.py files with proper exports
3. Create base model classes
4. Set up logging configuration

### Phase 2: Move Core Components (Day 2-3)
1. **GitHub Client Refactor**
   - Split client.py into client.py, auth.py, rate_limiter.py
   - Create exceptions.py for custom exceptions
   - Keep only API interaction logic

2. **Models Migration**
   - Create models/ directory
   - Move all data models to appropriate files
   - Create base model with common functionality

3. **Utils Consolidation**
   - Move CSV operations to utils/csv_utils.py
   - Move markdown generation to utils/markdown_utils.py
   - Create file_utils.py for file operations

### Phase 3: Migrate Feature Modules (Day 4-5)
1. **Issues Module**
   - Move issue_collector.py → issues/collector.py
   - Move collect_issues_to_csv.py → issues/exporters/csv_exporter.py
   - Move analyse/* → issues/processors/
   - Update all imports

2. **Organizations Module**
   - Move org-research/* → orgs/
   - Create orgs/analyzer.py for analytics
   - Add report generation capabilities

3. **Repositories Module**
   - Move repository collection logic → repos/collector.py
   - Move merged_prs_30d/* → repos/metrics/
   - Move filters/* → repos/filters/
   - Move fix/* → repos/fixers/

### Phase 4: Pipeline Integration (Day 6)
1. Move orchestrator.py → pipeline/orchestrator.py
2. Create workflow classes for each module
3. Update configuration handling
4. Create batch scheduling capabilities

### Phase 5: Testing and Documentation (Day 7)
1. Update all import statements
2. Run comprehensive tests
3. Update CLAUDE.md documentation
4. Create migration guide
5. Update README.md

## Key Improvements

### 1. Clear Separation of Concerns
- **issues/**: Everything related to GitHub issues
- **orgs/**: Organization-level operations
- **repos/**: Repository-specific operations
- **pipeline/**: Orchestration and workflows
- **utils/**: Shared utilities
- **models/**: Data models

### 2. Improved Code Organization
- Logical grouping of related functionality
- Clear import paths
- Reduced circular dependencies
- Better testability

### 3. Enhanced Maintainability
- Easy to locate specific functionality
- Clear responsibility boundaries
- Simplified debugging
- Better code reuse

### 4. Scalability Benefits
- Easy to add new features to appropriate modules
- Modular design allows independent development
- Clear extension points

## Migration Checklist

- [ ] Create new directory structure
- [ ] Move and refactor github_client/
- [ ] Migrate issues functionality
- [ ] Migrate organizations functionality
- [ ] Migrate repositories functionality
- [ ] Update pipeline/orchestrator
- [ ] Consolidate utilities
- [ ] Update all imports
- [ ] Run full test suite
- [ ] Update documentation
- [ ] Create backwards compatibility layer (if needed)
- [ ] Remove old directories
- [ ] Final testing and validation

## File Migration Mapping

### Issues Module
```
analyse/collect_issues.py → issues/processors/batch_processor.py
analyse/analyze_csv_issues.py → issues/analyzer.py
collect_issues_to_csv.py → issues/exporters/csv_exporter.py
github_client/issue_collector.py → issues/collector.py
```

### Organizations Module
```
org-research/collect_org_repos.py → orgs/collector.py
org-research/models.py → orgs/models.py
[NEW] → orgs/analyzer.py
[NEW] → orgs/reports/summary_report.py
```

### Repositories Module
```
github_client/collector.py → repos/collector.py
merged_prs_30d/fetch_merged_prs.py → repos/metrics/pr_metrics.py
merged_prs_30d/add_pr_column.py → repos/metrics/pr_metrics.py
merged_prs_30d/batch_processor.py → repos/processors/batch_processor.py
filters/filter_by_date.py → repos/filters/date_filter.py
filters/filter_by_pr_activity.py → repos/filters/activity_filter.py
filters/filter_top_percentile.py → repos/filters/percentile_filter.py
fix/fix_csv_counts.py → repos/fixers/count_fixer.py
fix/fix_github_counts_accurate.py → repos/fixers/count_fixer.py
fix/fix_pr_counts.py → repos/fixers/pr_fixer.py
fix/targeted_fix.py → repos/fixers/data_validator.py
```

### Utilities Module
```
combine/csv_combiner.py → utils/csv_utils.py
github_client/markdown_generator.py → utils/markdown_utils.py
github_client/utils.py → utils/[various]
```

### Pipeline Module
```
orchestrator.py → pipeline/orchestrator.py
[NEW] → pipeline/workflows/issue_workflow.py
[NEW] → pipeline/workflows/org_workflow.py
[NEW] → pipeline/workflows/repo_workflow.py
```

## Example Usage After Refactoring

```python
# Collect issues for repositories
from scripts.issues.collector import IssueCollector
from scripts.issues.exporters.csv_exporter import CSVExporter

collector = IssueCollector()
issues = collector.collect("facebook/react")
exporter = CSVExporter()
exporter.export(issues, "output/react_issues.csv")

# Analyze organization
from scripts.orgs.collector import OrganizationCollector
from scripts.orgs.analyzer import OrganizationAnalyzer

org_collector = OrganizationCollector("microsoft")
repos = org_collector.collect_all_repos()
analyzer = OrganizationAnalyzer()
metrics = analyzer.analyze(repos)

# Filter and process repositories
from scripts.repos.filters import DateFilter, ActivityFilter
from scripts.repos.metrics import PRMetrics

date_filter = DateFilter(after="2025-01-01")
activity_filter = ActivityFilter(min_prs=10)

filtered_repos = date_filter.apply(repos)
active_repos = activity_filter.apply(filtered_repos)

pr_metrics = PRMetrics()
for repo in active_repos:
    metrics = pr_metrics.calculate(repo)

# Run complete pipeline
from scripts.pipeline.orchestrator import PipelineOrchestrator
from scripts.pipeline.workflows import OrgWorkflow

orchestrator = PipelineOrchestrator()
workflow = OrgWorkflow(org_name="shopify")
results = orchestrator.run(workflow)
```

## Benefits Summary

1. **Developer Experience**
   - Intuitive directory structure
   - Clear module boundaries
   - Easy to understand codebase

2. **AI Assistant Experience (Claude)**
   - Clear navigation path
   - Logical organization for task execution
   - Easy to locate relevant code

3. **Maintenance**
   - Reduced technical debt
   - Easier bug fixes
   - Clear testing boundaries

4. **Performance**
   - Better code reuse
   - Optimized imports
   - Reduced redundancy

## Notes for Implementation

- Maintain backwards compatibility during migration
- Use feature flags to switch between old and new structure
- Implement comprehensive logging for debugging
- Create integration tests for critical workflows
- Document all breaking changes
- Consider creating a compatibility shim for smooth transition

## Priority Order for Refactoring

1. **High Priority** (Core functionality)
   - github_client/ refactor
   - models/ creation
   - utils/ consolidation

2. **Medium Priority** (Feature modules)
   - issues/ module
   - repos/ module
   - orgs/ module

3. **Low Priority** (Nice to have)
   - pipeline/ workflows
   - CLI interface
   - Advanced scheduling

## Testing Strategy

1. **Unit Tests**
   - Test each module independently
   - Mock external dependencies
   - Verify data transformations

2. **Integration Tests**
   - Test module interactions
   - Verify API calls
   - Test complete workflows

3. **Regression Tests**
   - Ensure backwards compatibility
   - Verify output consistency
   - Test migration paths

## Documentation Updates

1. Update CLAUDE.md with new structure
2. Create module-specific README files
3. Update main README.md
4. Create migration guide
5. Document breaking changes
6. Update example scripts

## Rollback Plan

1. Keep old structure in `scripts_legacy/` temporarily
2. Use environment variable to switch between old/new
3. Gradual migration with feature flags
4. Monitor for issues during transition
5. Quick rollback capability if needed